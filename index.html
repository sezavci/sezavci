<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Valentine</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Sacramento&display=swap"
        rel="stylesheet">
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #000;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
        }

        /* === INTRO SCREEN === */
        #intro-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background:
                radial-gradient(ellipse at top left, rgba(139, 0, 139, 0.3) 0%, rgba(0, 0, 0, 0.9) 50%),
                radial-gradient(ellipse at bottom right, rgba(255, 0, 85, 0.3) 0%, rgba(0, 0, 0, 0.9) 50()),
                #000;
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            transition: opacity 1s;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 0%, 100% 100%;
            }

            50% {
                background-position: 100% 100%, 0% 0%;
            }
        }

        /* Pixel heart in corner */
        .intro-heart-wrap {
            position: absolute;
            bottom: 150px;
            animation: heartbeat 1.2s ease-in-out infinite;
            pointer-events: none;
        }

        .intro-heart {
            width: 6px;
            height: 6px;
            background: transparent;
            color: #ff0055;
            box-shadow:
                12px 0, 18px 0, 42px 0, 48px 0,
                6px 6px, 12px 6px, 18px 6px, 24px 6px, 36px 6px, 42px 6px, 48px 6px, 54px 6px,
                0 12px, 6px 12px, 12px 12px, 18px 12px, 24px 12px, 30px 12px, 36px 12px, 42px 12px, 48px 12px, 54px 12px, 60px 12px,
                0 18px, 6px 18px, 12px 18px, 18px 18px, 24px 18px, 30px 18px, 36px 18px, 42px 18px, 48px 18px, 54px 18px, 60px 18px,
                6px 24px, 12px 24px, 18px 24px, 24px 24px, 30px 24px, 36px 24px, 42px 24px, 48px 24px, 54px 24px,
                12px 30px, 18px 30px, 24px 30px, 30px 30px, 36px 30px, 42px 30px, 48px 30px,
                18px 36px, 24px 36px, 30px 36px, 36px 36px, 42px 36px,
                24px 42px, 30px 42px, 36px 42px,
                30px 48px;
        }

        @keyframes heartbeat {

            0%,
            100% {
                transform: scale(2.5);
                opacity: 0.25;
            }

            50% {
                transform: scale(3);
                opacity: 0.45;
            }
        }

        .fancy-text {
            font-size: 1.2rem;
            line-height: 2;
            text-align: center;
            color: #ff7eb3;
            text-shadow: 2px 2px #000;
            z-index: 1;
        }

        input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #ff7eb3;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            text-align: center;
            width: 150px;
            outline: none;
            margin: 0 10px;
        }

        input::placeholder {
            color: #555;
        }

        button {
            margin-top: 30px;
            padding: 15px 30px;
            background: #ff7eb3;
            border: none;
            color: #000;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 4px 4px #fff;
            transition: transform 0.1s;
            z-index: 1;
        }

        button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px #fff;
        }

        /* === CANVAS LAYERS === */
        #canvas-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #particles-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 6;
            pointer-events: none;
        }

        /* === LOADING MESSAGES === */
        #loading-msg {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 4;
            font-size: 2.0rem;
            color: #ff7eb3;
            opacity: 0;
            transition: opacity 0.5s;
            text-shadow: 0 0 15px #ff0055, 0 0 30px #ff0055;
            letter-spacing: 2px;
        }

        /* === GLOW BORDER (after reveal) === */
        #glow-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
            opacity: 0;
            transition: opacity 2s;
            box-shadow: inset 0 0 80px rgba(255, 0, 85, 0.4), inset 0 0 160px rgba(255, 0, 85, 0.15);
            animation: glowPulse 3s ease-in-out infinite;
        }

        @keyframes glowPulse {

            0%,
            100% {
                box-shadow: inset 0 0 80px rgba(255, 0, 85, 0.3), inset 0 0 160px rgba(255, 0, 85, 0.1);
            }

            50% {
                box-shadow: inset 0 0 120px rgba(255, 0, 85, 0.5), inset 0 0 200px rgba(255, 0, 85, 0.2);
            }
        }

        /* === VALENTINE OVERLAY === */
        #final-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 5;
            opacity: 0;
            pointer-events: none;
            transition: opacity 3s;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        }

        .valentine-msg {
            font-size: 1.8rem;
            text-align: center;
            color: #fff;
            text-shadow:
                3px 3px 0 #ff0055,
                -1px -1px 0 #ff0055,
                1px -1px 0 #ff0055,
                -1px 1px 0 #ff0055,
                1px 1px 0 #ff0055,
                0 0 30px #ff0055;
            margin-bottom: 50px;
            min-height: 1.2em;
            letter-spacing: 3px;
        }
    </style>
</head>

<body>

    <div id="intro-layer">
        <div class="intro-heart-wrap">
            <div class="intro-heart"></div>
        </div>
        <div class="fancy-text">
            Hey, <input type="text" id="nameInput" placeholder="Name" autocomplete="off"> <br>
            I need your lucky number >- -< <br>
                <input type="number" id="seedInput" placeholder="777">
        </div>
        <button onclick="startMagic()">Generate Magic</button>
    </div>

    <canvas id="canvas-layer"></canvas>
    <canvas id="particles-layer"></canvas>
    <div id="loading-msg"></div>
    <div id="glow-border"></div>

    <div id="final-layer">
        <div class="valentine-msg" id="valMsg"></div>
    </div>

    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";

        // UPDATE THIS LINK FROM YOUR COLAB EVERY TIME YOU RESTART
        const GRADIO_URL = "https://a232a075a1ecb974b7.gradio.live";

        // ===================== FAVICON (pixel heart) =====================
        (function () {
            const c = document.createElement('canvas');
            c.width = 32; c.height = 32;
            const x = c.getContext('2d');
            x.fillStyle = '#ff0055';
            const rows = [
                '0011001100',
                '0111111110',
                '1111111111',
                '1111111111',
                '0111111110',
                '0011111100',
                '0001111000',
                '0000110000',
            ];
            rows.forEach((row, y) => {
                [...row].forEach((p, px) => {
                    if (p === '1') x.fillRect(1 + px * 3, 2 + y * 3, 3, 3);
                });
            });
            const link = document.createElement('link');
            link.rel = 'icon';
            link.href = c.toDataURL();
            document.head.appendChild(link);
        })();

        // ===================== 8-BIT MUSIC =====================
        let audioCtx = null;
        function startMusic() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Romantic 8-bit arpeggio: Câ†’Amâ†’Fâ†’G progression
            const melody = [
                523.25, 659.25, 783.99, 1046.50,   // C major
                880.00, 659.25, 523.25, 440.00,     // A minor
                349.23, 440.00, 523.25, 698.46,     // F major
                392.00, 493.88, 587.33, 783.99,     // G major
            ];
            const noteDur = 0.3;
            const loopLen = melody.length * noteDur;

            for (let loop = 0; loop < 25; loop++) {
                melody.forEach((freq, i) => {
                    const t = audioCtx.currentTime + loop * loopLen + i * noteDur;
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.04, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + noteDur - 0.02);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(t);
                    osc.stop(t + noteDur);
                });
            }
        }

        // ===================== LOADING MESSAGES =====================
        const MESSAGES = [
            "Planting seeds...",
            "Watering flowers...",
            "Adding sunshine...",
            "Sprinkling love...",
            "Arranging petals...",
            "Tying ribbons...",
            "Adding magic...",
            "Almost there...",
        ];
        let msgTimer = null;
        function startLoadingMessages() {
            const el = document.getElementById('loading-msg');
            el.style.opacity = '1';
            let idx = 0;
            el.textContent = MESSAGES[0];
            msgTimer = setInterval(() => {
                idx = (idx + 1) % MESSAGES.length;
                el.textContent = MESSAGES[idx];
            }, 4000);
        }
        function stopLoadingMessages() {
            clearInterval(msgTimer);
            document.getElementById('loading-msg').style.opacity = '0';
        }

        // ===================== PARTICLES (hearts + sparkles) =====================
        const pCanvas = document.getElementById('particles-layer');
        const pCtx = pCanvas.getContext('2d');
        let hearts = [];
        let sparkles = [];
        let particlesActive = false;

        function resizeParticles() {
            pCanvas.width = window.innerWidth;
            pCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeParticles);
        resizeParticles();

        // Pixel heart shape (5x5 grid)
        function drawPixelHeart(ctx, x, y, size, color, alpha) {
            ctx.globalAlpha = alpha;
            ctx.fillStyle = color;
            const s = size;
            const pattern = [
                [0, 1, 0, 1, 0],
                [1, 1, 1, 1, 1],
                [1, 1, 1, 1, 1],
                [0, 1, 1, 1, 0],
                [0, 0, 1, 0, 0],
            ];
            pattern.forEach((row, ry) => {
                row.forEach((p, rx) => {
                    if (p) ctx.fillRect(x + rx * s, y + ry * s, s, s);
                });
            });
            ctx.globalAlpha = 1;
        }

        function spawnHearts(count) {
            for (let i = 0; i < count; i++) {
                hearts.push({
                    x: Math.random() * pCanvas.width,
                    y: -20 - Math.random() * pCanvas.height,
                    size: 2 + Math.random() * 3,
                    speed: 0.5 + Math.random() * 1.5,
                    wobble: Math.random() * Math.PI * 2,
                    wobbleSpeed: 0.01 + Math.random() * 0.02,
                    alpha: 0.3 + Math.random() * 0.5,
                    color: ['#ff0055', '#ff7eb3', '#ff3388', '#ff5599'][Math.floor(Math.random() * 4)],
                });
            }
        }

        function spawnSparkles(count) {
            for (let i = 0; i < count; i++) {
                sparkles.push({
                    x: Math.random() * pCanvas.width,
                    y: Math.random() * pCanvas.height,
                    size: 1 + Math.random() * 2,
                    phase: Math.random() * Math.PI * 2,
                    speed: 0.02 + Math.random() * 0.04,
                });
            }
        }

        function animateParticles() {
            if (!particlesActive) return;
            pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);

            // Hearts
            hearts.forEach(h => {
                h.y += h.speed;
                h.wobble += h.wobbleSpeed;
                const wx = h.x + Math.sin(h.wobble) * 20;
                drawPixelHeart(pCtx, wx, h.y, h.size, h.color, h.alpha);
                if (h.y > pCanvas.height + 30) {
                    h.y = -30;
                    h.x = Math.random() * pCanvas.width;
                }
            });

            // Sparkles
            sparkles.forEach(s => {
                s.phase += s.speed;
                const alpha = (Math.sin(s.phase) + 1) / 2 * 0.8;
                pCtx.globalAlpha = alpha;
                pCtx.fillStyle = '#fff';
                pCtx.fillRect(s.x, s.y, s.size, s.size);
                pCtx.fillRect(s.x - s.size, s.y, s.size * 3, s.size); // cross shape
                pCtx.fillRect(s.x, s.y - s.size, s.size, s.size * 3);
            });
            pCtx.globalAlpha = 1;

            requestAnimationFrame(animateParticles);
        }

        // ===================== TYPEWRITER =====================
        function typeWriter(el, text, speed, callback) {
            el.innerHTML = '';
            let i = 0;
            const timer = setInterval(() => {
                el.innerHTML += text.charAt(i);
                i++;
                if (i >= text.length) {
                    clearInterval(timer);
                    if (callback) callback();
                }
            }, speed);
        }

        // ===================== MAIN CANVAS (noise/denoising) =====================
        const canvas = document.getElementById('canvas-layer');
        const ctx = canvas.getContext('2d');
        let width, height, animationId;
        let finalImageObj = null;
        let isDenoising = false;
        let noiseStrength = 255;
        let targetPixelsCache = null;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            targetPixelsCache = null;
        }
        window.addEventListener('resize', resize);
        resize();

        function getGridLayout() {
            return window.innerWidth >= window.innerHeight
                ? { cols: 4, rows: 2 }
                : { cols: 2, rows: 4 };
        }

        function computeCellSize() {
            const { cols, rows } = getGridLayout();
            const cellPx = Math.floor(Math.min(window.innerWidth / cols, window.innerHeight / rows) / 8) * 8;
            return Math.max(cellPx, 256);
        }

        function drawContain(destCtx, img, w, h) {
            const { cols, rows } = getGridLayout();
            const cellW = w / cols;
            const cellH = h / rows;

            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const sx = (col / cols) * img.width;
                    const sy = (row / rows) * img.height;
                    const sw = img.width / cols;
                    const sh = img.height / rows;
                    const dx = col * cellW;
                    const dy = row * cellH;

                    destCtx.drawImage(img, sx, sy, sw, sh, dx, dy, cellW, cellH);
                }
            }
        }

        function drawFrame() {
            const imageData = ctx.createImageData(width, height);
            const data = imageData.data;

            if (isDenoising && finalImageObj && !targetPixelsCache) {
                const off = document.createElement('canvas');
                off.width = width; off.height = height;
                const octx = off.getContext('2d');
                octx.fillStyle = '#000';
                octx.fillRect(0, 0, width, height);
                drawContain(octx, finalImageObj, width, height);
                targetPixelsCache = octx.getImageData(0, 0, width, height).data;
            }

            for (let i = 0; i < data.length; i += 4) {
                if (isDenoising && targetPixelsCache) {
                    const f = noiseStrength / 255;
                    // Pink noise for denoising transition
                    const pinkR = 80 + Math.random() * 120;
                    const pinkG = 20 + Math.random() * 60;
                    const pinkB = 40 + Math.random() * 80;
                    data[i] = targetPixelsCache[i] * (1 - f) + pinkR * f;
                    data[i + 1] = targetPixelsCache[i + 1] * (1 - f) + pinkG * f;
                    data[i + 2] = targetPixelsCache[i + 2] * (1 - f) + pinkB * f;
                } else {
                    // Soft pink noise
                    data[i] = 80 + Math.random() * 120;
                    data[i + 1] = 20 + Math.random() * 60;
                    data[i + 2] = 40 + Math.random() * 80;
                }
                data[i + 3] = 255;
            }
            ctx.putImageData(imageData, 0, 0);

            if (isDenoising) {
                noiseStrength -= 2;
                if (noiseStrength <= 0) {
                    noiseStrength = 0;
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, width, height);
                    drawContain(ctx, finalImageObj, width, height);
                    showFinale();
                    return;
                }
            }
            animationId = requestAnimationFrame(drawFrame);
        }
        drawFrame();

        // ===================== FINALE =====================
        function showFinale() {
            // Stop loading messages
            stopLoadingMessages();

            // Glow border
            document.getElementById('glow-border').style.opacity = '1';

            // Valentine overlay
            document.getElementById('final-layer').style.opacity = '1';

            // Typewriter message with pixel emojis
            const name = document.getElementById('nameInput').value || "Love";
            typeWriter(
                document.getElementById('valMsg'),
                `ðŸ’— Happy Valentine's Day ${name} ðŸ’ <3`,
                80
            );

            // Start sparkles
            spawnSparkles(120);
        }

        // ===================== START =====================
        window.startMagic = async function () {
            const name = document.getElementById('nameInput').value || "Love";
            const seed = Number(document.getElementById('seedInput').value) || Math.floor(Math.random() * 1000);
            const imgSize = computeCellSize();
            const { cols } = getGridLayout();

            // Start music (needs user gesture)
            startMusic();

            // Start falling hearts + particle animation
            particlesActive = true;
            spawnHearts(100);
            animateParticles();

            // Fade intro
            document.getElementById('intro-layer').style.opacity = '0';
            setTimeout(() => document.getElementById('intro-layer').style.display = 'none', 1000);

            // Start loading messages
            startLoadingMessages();

            try {
                const app = await Client.connect(GRADIO_URL);

                const result = await app.predict("/generate_batch", [
                    parseFloat(seed),
                    8,
                    1.5,
                    imgSize,
                    cols
                ]);

                const data = result.data[0];
                const imageUrl = typeof data === 'string' ? data : data.url;

                const resp = await fetch(imageUrl);
                const blob = await resp.blob();
                const blobUrl = URL.createObjectURL(blob);

                const img = new Image();
                img.onload = () => {
                    finalImageObj = img;
                    isDenoising = true;
                };
                img.onerror = () => {
                    alert("Failed to load the generated image!");
                    location.reload();
                };
                img.src = blobUrl;

            } catch (e) {
                console.error("Connection failed:", e);
                alert("The magic disconnected! Check if Colab is running. Error: " + e.message);
            }
        };
    </script>
</body>

</html>
